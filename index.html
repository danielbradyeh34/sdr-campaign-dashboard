<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SDR Campaign Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg-primary: #f5f6fa;
    --bg-secondary: #edf0f7;
    --bg-card: #ffffff;
    --bg-card-hover: #f8f9fc;
    --border: #e0e4ef;
    --text-primary: #1a1d2e;
    --text-secondary: #525872;
    --text-muted: #8890a8;
    --accent-purple: #6d28d9;
    --accent-blue: #2563eb;
    --accent-green: #16a34a;
    --accent-red: #dc2626;
    --accent-amber: #d97706;
    --accent-orange: #ea580c;
    --gradient-start: #6d28d9;
    --gradient-end: #2563eb;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #d97706;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
  }

  .header {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    padding: 28px 40px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.12);
  }

  .header-inner {
    max-width: 1440px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header h1 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: #fff;
  }

  .header-subtitle {
    font-size: 13px;
    color: rgba(255,255,255,0.7);
    margin-top: 2px;
  }

  .campaign-toggle {
    display: flex;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 4px;
    gap: 4px;
  }

  .toggle-btn {
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
    color: rgba(255,255,255,0.6);
    background: transparent;
  }

  .toggle-btn.active {
    background: rgba(255,255,255,0.3);
    color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .toggle-btn:hover:not(.active) {
    color: rgba(255,255,255,0.85);
    background: rgba(255,255,255,0.1);
  }

  .container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 24px 40px 40px;
  }

  /* KPI Cards */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 16px;
    margin-bottom: 28px;
  }

  .kpi-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px 24px;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }

  .kpi-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .kpi-value {
    font-size: 32px;
    font-weight: 800;
    letter-spacing: -1px;
    color: var(--text-primary);
  }

  .kpi-value.purple { color: var(--accent-purple); }
  .kpi-value.blue { color: var(--accent-blue); }
  .kpi-value.green { color: var(--accent-green); }
  .kpi-value.amber { color: var(--accent-amber); }
  .kpi-value.orange { color: var(--accent-orange); }

  .kpi-detail {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
  }

  /* Chart Grid */
  .chart-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }

  .chart-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .chart-card.full-width {
    grid-column: 1 / -1;
  }

  .chart-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .chart-subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: -12px;
    margin-bottom: 16px;
  }

  .chart-summary {
    font-size: 13px;
    color: var(--text-secondary);
    background: var(--bg-primary);
    border-left: 3px solid var(--accent-purple);
    border-radius: 0 6px 6px 0;
    padding: 10px 14px;
    margin-top: 14px;
    line-height: 1.55;
  }

  .chart-container {
    position: relative;
    width: 100%;
  }

  .chart-container.bar-tall {
    height: 400px;
  }

  .chart-container.donut {
    height: 320px;
  }

  .chart-container.campaign-bar {
    height: 300px;
  }

  /* Heatmap Table */
  .heatmap-wrapper {
    overflow-x: auto;
  }

  .heatmap-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .heatmap-table th {
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
  }

  .heatmap-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    text-align: center;
    font-weight: 600;
    border-radius: 0;
    transition: background 0.2s;
  }

  .heatmap-table td:first-child {
    text-align: left;
    color: var(--text-primary);
    font-weight: 500;
  }

  .heatmap-table tr:hover td {
    background: var(--bg-card-hover);
  }

  .heat-cell {
    border-radius: 6px;
    min-width: 70px;
    display: inline-block;
    padding: 4px 10px;
  }

  /* Coaching Panel */
  .coaching-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 28px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .coaching-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .coaching-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .coaching-section {
    background: var(--bg-primary);
    border-radius: 10px;
    padding: 20px;
    border-left: 4px solid;
  }

  .coaching-section.top-performers { border-left-color: var(--accent-green); }
  .coaching-section.needs-coaching { border-left-color: var(--accent-red); }
  .coaching-section.market-alert { border-left-color: var(--accent-amber); }
  .coaching-section.diagnostic { border-left-color: var(--accent-blue); }

  .coaching-section h3 {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 12px;
  }

  .coaching-section.top-performers h3 { color: var(--accent-green); }
  .coaching-section.needs-coaching h3 { color: var(--accent-red); }
  .coaching-section.market-alert h3 { color: var(--accent-amber); }
  .coaching-section.diagnostic h3 { color: var(--accent-blue); }

  .coaching-item {
    font-size: 13px;
    color: var(--text-secondary);
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    line-height: 1.5;
  }

  .coaching-item:last-child { border-bottom: none; }

  .coaching-item strong { color: var(--text-primary); }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
  }

  .badge-green { background: rgba(22,163,74,0.1); color: var(--accent-green); }
  .badge-red { background: rgba(220,38,38,0.1); color: var(--accent-red); }
  .badge-amber { background: rgba(217,119,6,0.1); color: var(--accent-amber); }

  /* Data Table */
  .data-table-wrapper {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 28px;
    overflow-x: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .data-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: color 0.2s;
  }

  .data-table th:hover { color: var(--text-primary); }

  .data-table th .sort-arrow { margin-left: 4px; font-size: 10px; }

  .data-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
  }

  .data-table tr:hover td {
    background: var(--bg-card-hover);
    color: var(--text-primary);
  }

  .win-rate-bar {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .win-rate-fill {
    height: 6px;
    border-radius: 3px;
    min-width: 2px;
  }

  /* Funnel */
  .funnel-container {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 0;
  }

  .funnel-step {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .funnel-label {
    width: 120px;
    text-align: right;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .funnel-bar-wrapper {
    flex: 1;
    position: relative;
  }

  .funnel-bar {
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 13px;
    font-weight: 700;
    color: #fff;
    min-width: 40px;
    transition: width 0.6s ease;
  }

  .funnel-count {
    font-size: 12px;
    color: var(--text-muted);
    margin-left: 10px;
    white-space: nowrap;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 24px 40px;
    color: var(--text-muted);
    font-size: 13px;
    border-top: 1px solid var(--border);
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .kpi-row { grid-template-columns: repeat(3, 1fr); }
    .coaching-grid { grid-template-columns: 1fr; }
  }

  @media (max-width: 900px) {
    .container { padding: 16px 20px 20px; }
    .header { padding: 20px; }
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
    .chart-grid { grid-template-columns: 1fr; }
    .header-inner { flex-direction: column; align-items: flex-start; }
  }

  @media (max-width: 600px) {
    .kpi-row { grid-template-columns: 1fr; }
    .header h1 { font-size: 18px; }
  }

  /* Time selector */
  .time-selector {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .time-selector label {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
  }

  .time-select {
    padding: 8px 14px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 30px;
  }

  .time-select option {
    background: #1e293b;
    color: #fff;
  }

  .time-note {
    font-size: 11px;
    color: var(--accent-amber);
    background: rgba(217,119,6,0.08);
    border: 1px solid rgba(217,119,6,0.2);
    border-radius: 6px;
    padding: 6px 12px;
    margin-bottom: 20px;
    display: none;
  }

  .time-note.visible { display: block; }

  .chart-container.trend { height: 220px; }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div>
      <h1>SDR Campaign Performance Dashboard</h1>
      <div class="header-subtitle">Employment Hero - RevOps Analytics</div>
    </div>
    <div class="header-controls">
      <div class="campaign-toggle">
        <button class="toggle-btn active" onclick="switchCampaign('PY')" id="btn-py">Payroll Guide (PY)</button>
        <button class="toggle-btn" onclick="switchCampaign('OB')" id="btn-ob">Onboarding Checklist (OB)</button>
      </div>
      <div class="time-selector">
        <label>Period:</label>
        <select class="time-select" id="time-select" onchange="switchTimePeriod(this.value)">
          <option value="all">All Time</option>
          <option value="2025-11">Nov 2025</option>
          <option value="2025-12">Dec 2025</option>
          <option value="2026-01">Jan 2026</option>
          <option value="L3M">Last 3 Months</option>
        </select>
      </div>
    </div>
  </div>
</header>

<div class="container">
  <!-- KPI Cards -->
  <div class="kpi-row" id="kpi-row">
    <div class="kpi-card">
      <div class="kpi-label">Total Leads</div>
      <div class="kpi-value purple" id="kpi-leads">1,091</div>
      <div class="kpi-detail" id="kpi-leads-detail">PY: 719 | OB: 372</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Conversion Rate</div>
      <div class="kpi-value green" id="kpi-conv">4.27%</div>
      <div class="kpi-detail" id="kpi-conv-detail">Demos / Total Resolved</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Demos Booked</div>
      <div class="kpi-value blue" id="kpi-demos">30</div>
      <div class="kpi-detail" id="kpi-demos-detail">PY: 23 | OB: 7</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Active SDRs</div>
      <div class="kpi-value amber" id="kpi-sdrs">9</div>
      <div class="kpi-detail" id="kpi-sdrs-detail">Working this campaign</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Campaign Variants</div>
      <div class="kpi-value orange" id="kpi-campaigns">6</div>
      <div class="kpi-detail" id="kpi-campaigns-detail">Active variants</div>
    </div>
  </div>

  <!-- Time filter note -->
  <div class="time-note" id="time-note">
    Showing demos booked in the selected period. Pipeline totals (Lost, Hunting) are shown as all-time since individual lead dates are not available in this dataset. With live Salesforce data, all metrics will filter by date.
  </div>

  <!-- Monthly Trend -->
  <div class="chart-grid" style="margin-bottom:20px;">
    <div class="chart-card full-width">
      <div class="chart-title">Monthly Demo Booking Trend</div>
      <div class="chart-subtitle">Demos booked per month by rep - tracks coaching impact over time</div>
      <div class="chart-container trend">
        <canvas id="trendChart"></canvas>
      </div>
      <div class="chart-summary" id="summary-trend">Loading...</div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="chart-grid">
    <!-- Rep Conversion Bar Chart -->
    <div class="chart-card">
      <div class="chart-title">Rep Conversion Rate (Win %)</div>
      <div class="chart-subtitle">Sorted by performance - green = above avg, red = below avg</div>
      <div class="chart-container bar-tall">
        <canvas id="repBarChart"></canvas>
      </div>
      <div class="chart-summary" id="summary-rep">Loading...</div>
    </div>

    <!-- Market Donut -->
    <div class="chart-card">
      <div class="chart-title">Market Segment Distribution</div>
      <div class="chart-subtitle">Lead volume and conversion by market segment</div>
      <div class="chart-container donut">
        <canvas id="marketDonut"></canvas>
      </div>
      <div id="market-legend" style="margin-top:16px;"></div>
      <div class="chart-summary" id="summary-market">Loading...</div>
    </div>

    <!-- Lead Status Funnel -->
    <div class="chart-card">
      <div class="chart-title">Lead Status Funnel</div>
      <div class="chart-subtitle">Current status distribution of all leads</div>
      <div id="funnel-container" class="funnel-container"></div>
      <div class="chart-summary" id="summary-funnel">Loading...</div>
    </div>

    <!-- Campaign Variant Performance -->
    <div class="chart-card">
      <div class="chart-title">Campaign Variant Performance</div>
      <div class="chart-subtitle">Conversion by campaign variant</div>
      <div class="chart-container campaign-bar">
        <canvas id="campaignChart"></canvas>
      </div>
      <div class="chart-summary" id="summary-campaign">Loading...</div>
    </div>

    <!-- Heatmap -->
    <div class="chart-card full-width">
      <div class="chart-title">Rep x Market Heatmap</div>
      <div class="chart-subtitle">Win % by rep and market segment - darker green = higher conversion</div>
      <div class="heatmap-wrapper" id="heatmap-wrapper"></div>
      <div class="chart-summary" id="summary-heatmap">Loading...</div>
    </div>
  </div>

  <!-- Coaching Insights -->
  <div class="coaching-panel">
    <div class="coaching-title">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      Coaching Insights &amp; Diagnostics
    </div>
    <div class="coaching-grid" id="coaching-grid"></div>
  </div>

  <!-- Sortable Data Table -->
  <div class="data-table-wrapper">
    <div class="chart-title" style="margin-bottom:16px;">Detailed Rep x Market Breakdown</div>
    <div class="chart-subtitle" style="margin-top:-12px;margin-bottom:16px;">Click column headers to sort</div>
    <table class="data-table" id="data-table">
      <thead id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>
    <div class="chart-summary" id="summary-table">Loading...</div>
  </div>
</div>

<footer class="footer">
  Data as of Feb 2026 | Built by RevOps Automation | Proof of Concept
</footer>

<script>
// ============================
// DATA
// ============================

const DATA = {
  PY: {
    totalLeads: 719,
    variants: 6,
    repMarket: [
      { rep: 'Adam Mellouli', market: 'Core', demos: 3, lost: 115, total: 118, win: 2.54 },
      { rep: 'Adam Mellouli', market: 'Micro', demos: 6, lost: 107, total: 113, win: 5.31 },
      { rep: 'Adam Mellouli', market: 'Mid-Market', demos: 0, lost: 48, total: 48, win: 0.00 },
      { rep: 'Afraz Afridi', market: 'Core', demos: 1, lost: 14, total: 15, win: 6.67 },
      { rep: 'Afraz Afridi', market: 'Micro', demos: 0, lost: 8, total: 8, win: 0.00 },
      { rep: 'Afraz Afridi', market: 'Mid-Market', demos: 0, lost: 8, total: 8, win: 0.00 },
      { rep: 'Camilo Gomez', market: 'Core', demos: 0, lost: 10, total: 10, win: 0.00 },
      { rep: 'Camilo Gomez', market: 'Micro', demos: 0, lost: 19, total: 19, win: 0.00 },
      { rep: 'Camilo Gomez', market: 'Mid-Market', demos: 0, lost: 6, total: 6, win: 0.00 },
      { rep: 'Dale Liang', market: 'Core', demos: 2, lost: 13, total: 15, win: 13.33 },
      { rep: 'Dale Liang', market: 'Micro', demos: 2, lost: 10, total: 12, win: 16.67 },
      { rep: 'Dale Liang', market: 'Mid-Market', demos: 0, lost: 5, total: 5, win: 0.00 },
      { rep: 'Diego Medrano', market: 'Core', demos: 1, lost: 4, total: 5, win: 20.00 },
      { rep: 'Diego Medrano', market: 'Micro', demos: 0, lost: 8, total: 8, win: 0.00 },
      { rep: 'Diego Medrano', market: 'Mid-Market', demos: 0, lost: 2, total: 2, win: 0.00 },
      { rep: 'Joanna Torrano', market: 'Core', demos: 0, lost: 1, total: 1, win: 0.00 },
      { rep: 'Joanna Torrano', market: 'Micro', demos: 0, lost: 3, total: 3, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Core', demos: 0, lost: 10, total: 10, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Micro', demos: 0, lost: 3, total: 3, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Mid-Market', demos: 0, lost: 8, total: 8, win: 0.00 },
      { rep: "Sid'Ali Terkmane", market: 'Core', demos: 2, lost: 17, total: 19, win: 10.53 },
      { rep: "Sid'Ali Terkmane", market: 'Micro', demos: 3, lost: 16, total: 19, win: 15.79 },
      { rep: "Sid'Ali Terkmane", market: 'Mid-Market', demos: 0, lost: 9, total: 9, win: 0.00 },
      { rep: 'Steven Kovacs', market: 'Core', demos: 0, lost: 13, total: 13, win: 0.00 },
      { rep: 'Steven Kovacs', market: 'Micro', demos: 1, lost: 5, total: 6, win: 16.67 },
      { rep: 'Steven Kovacs', market: 'Mid-Market', demos: 0, lost: 9, total: 9, win: 0.00 },
    ],
    repTotals: [
      { rep: 'Dale Liang', demos: 4, lost: 28, total: 32, win: 12.50 },
      { rep: "Sid'Ali Terkmane", demos: 5, lost: 42, total: 47, win: 10.64 },
      { rep: 'Diego Medrano', demos: 1, lost: 14, total: 15, win: 6.67 },
      { rep: 'Afraz Afridi', demos: 1, lost: 30, total: 31, win: 3.23 },
      { rep: 'Steven Kovacs', demos: 1, lost: 27, total: 28, win: 3.57 },
      { rep: 'Adam Mellouli', demos: 9, lost: 270, total: 279, win: 3.23 },
      { rep: 'Camilo Gomez', demos: 0, lost: 35, total: 35, win: 0.00 },
      { rep: 'Melissa Mills', demos: 0, lost: 21, total: 21, win: 0.00 },
      { rep: 'Joanna Torrano', demos: 0, lost: 4, total: 4, win: 0.00 },
    ],
    marketTotals: [
      { market: 'Core', demos: 9, lost: 197, total: 206, win: 4.37 },
      { market: 'Micro', demos: 12, lost: 179, total: 191, win: 6.28 },
      { market: 'Mid-Market', demos: 0, lost: 95, total: 95, win: 0.00 },
    ],
    campaigns: [
      { code: 'DE-2509-DP-GC-PSO-Facebook-DL-CAN-NAT-FR-Payroll_Guide_2025', demos: 13, lost: 289, total: 302 },
      { code: 'DE-2509-DP-GC-PSO-Linkedin-DL-CAN-ROC-EN-Payroll_Guide_2025', demos: 5, lost: 106, total: 111 },
      { code: 'DE-2509-DP-GC-PSO-Facebook-DL-CAN-ROC-EN-Payroll_Guide_2025', demos: 5, lost: 42, total: 47 },
      { code: 'DE-2601-DP-GC-PSO-Facebook-DL-CAN-NAT-EN-Payroll_Guide_2026', demos: 0, lost: 25, total: 25 },
      { code: 'DE-2509-DP-GC-PSO-Facebook-DL-CAN-QC-EN-Payroll_Guide_2025', demos: 0, lost: 8, total: 8 },
      { code: 'DE-2601-DP-GC-PSO-Linkedin-DL-CAN-NAT-EN-Payroll_Guide_2026', demos: 0, lost: 2, total: 2 },
    ],
    leadStatus: [
      { status: 'Lost', count: 472 },
      { status: 'Hunting', count: 172 },
      { status: 'New', count: 45 },
      { status: 'Demo Booked', count: 23 },
      { status: 'Working', count: 4 },
      { status: 'New Contact', count: 2 },
      { status: 'Qualified', count: 1 },
    ],
  },
  OB: {
    totalLeads: 372,
    variants: 5,
    repMarket: [
      { rep: 'Adam Mellouli', market: 'Core', demos: 2, lost: 22, total: 24, win: 8.33 },
      { rep: 'Adam Mellouli', market: 'Micro', demos: 0, lost: 5, total: 5, win: 0.00 },
      { rep: 'Adam Mellouli', market: 'Mid-Market', demos: 1, lost: 11, total: 12, win: 8.33 },
      { rep: 'Afraz Afridi', market: 'Core', demos: 0, lost: 13, total: 13, win: 0.00 },
      { rep: 'Afraz Afridi', market: 'Micro', demos: 0, lost: 10, total: 10, win: 0.00 },
      { rep: 'Afraz Afridi', market: 'Mid-Market', demos: 0, lost: 5, total: 5, win: 0.00 },
      { rep: 'Camilo Gomez', market: 'Core', demos: 1, lost: 17, total: 18, win: 5.56 },
      { rep: 'Camilo Gomez', market: 'Micro', demos: 0, lost: 15, total: 15, win: 0.00 },
      { rep: 'Camilo Gomez', market: 'Mid-Market', demos: 0, lost: 4, total: 4, win: 0.00 },
      { rep: 'Dale Liang', market: 'Core', demos: 0, lost: 9, total: 9, win: 0.00 },
      { rep: 'Dale Liang', market: 'Micro', demos: 1, lost: 6, total: 7, win: 14.29 },
      { rep: 'Dale Liang', market: 'Mid-Market', demos: 0, lost: 6, total: 6, win: 0.00 },
      { rep: 'Diego Medrano', market: 'Core', demos: 0, lost: 6, total: 6, win: 0.00 },
      { rep: 'Diego Medrano', market: 'Micro', demos: 0, lost: 5, total: 5, win: 0.00 },
      { rep: 'Diego Medrano', market: 'Mid-Market', demos: 0, lost: 2, total: 2, win: 0.00 },
      { rep: 'Joanna Torrano', market: 'Mid-Market', demos: 0, lost: 1, total: 1, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Core', demos: 0, lost: 23, total: 23, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Micro', demos: 0, lost: 1, total: 1, win: 0.00 },
      { rep: 'Melissa Mills', market: 'Mid-Market', demos: 0, lost: 6, total: 6, win: 0.00 },
      { rep: "Sid'Ali Terkmane", market: 'Micro', demos: 0, lost: 2, total: 2, win: 0.00 },
      { rep: 'Steven Kovacs', market: 'Core', demos: 2, lost: 19, total: 21, win: 9.52 },
      { rep: 'Steven Kovacs', market: 'Micro', demos: 0, lost: 5, total: 5, win: 0.00 },
      { rep: 'Steven Kovacs', market: 'Mid-Market', demos: 0, lost: 12, total: 12, win: 0.00 },
    ],
    repTotals: [
      { rep: 'Adam Mellouli', demos: 3, lost: 38, total: 41, win: 7.32 },
      { rep: 'Steven Kovacs', demos: 2, lost: 36, total: 38, win: 5.26 },
      { rep: 'Dale Liang', demos: 1, lost: 21, total: 22, win: 4.55 },
      { rep: 'Camilo Gomez', demos: 1, lost: 36, total: 37, win: 2.70 },
      { rep: 'Afraz Afridi', demos: 0, lost: 28, total: 28, win: 0.00 },
      { rep: 'Melissa Mills', demos: 0, lost: 30, total: 30, win: 0.00 },
      { rep: 'Diego Medrano', demos: 0, lost: 13, total: 13, win: 0.00 },
      { rep: "Sid'Ali Terkmane", demos: 0, lost: 2, total: 2, win: 0.00 },
      { rep: 'Joanna Torrano', demos: 0, lost: 1, total: 1, win: 0.00 },
    ],
    marketTotals: [
      { market: 'Core', demos: 5, lost: 109, total: 114, win: 4.39 },
      { market: 'Micro', demos: 1, lost: 49, total: 50, win: 2.00 },
      { market: 'Mid-Market', demos: 1, lost: 47, total: 48, win: 2.08 },
    ],
    campaigns: [
      { code: 'DE-2509-DP-GC-PSO-Facebook-DL-CAN-NAT-FR-Onboarding_Checklist', demos: 3, lost: 95, total: 98 },
      { code: 'DE-2509-DP-GC-PSO-Facebook-DL-CAN-ROC-EN-Onboarding_Checklist', demos: 2, lost: 38, total: 40 },
      { code: 'DE-2509-DP-GC-PSO-Linkedin-DL-CAN-ROC-EN-Onboarding_Checklist', demos: 2, lost: 36, total: 38 },
      { code: 'DE-2601-DP-GC-PSO-Facebook-DL-CAN-NAT-EN-Onboarding_Checklist', demos: 0, lost: 28, total: 28 },
      { code: 'DE-2601-DP-GC-PSO-Linkedin-DL-CAN-NAT-EN-Onboarding_Checklist', demos: 0, lost: 8, total: 8 },
    ],
    leadStatus: [
      { status: 'Lost', count: 205 },
      { status: 'Hunting', count: 98 },
      { status: 'New', count: 40 },
      { status: 'Demo Booked', count: 7 },
      { status: 'Working', count: 12 },
      { status: 'New Contact', count: 6 },
      { status: 'Qualified', count: 4 },
    ],
  }
};

// ============================
// DEMO RECORDS WITH DATES
// ============================
const DEMOS = {
  PY: [
    { rep: 'Adam Mellouli', date: '2025-11-05', market: 'Core', month: '2025-11' },
    { rep: 'Adam Mellouli', date: '2025-11-26', market: 'Micro', month: '2025-11' },
    { rep: 'Adam Mellouli', date: '2025-11-26', market: 'Micro', month: '2025-11' },
    { rep: "Sid'Ali Terkmane", date: '2025-11-27', market: 'Micro', month: '2025-11' },
    { rep: 'Diego Medrano', date: '2025-11-27', market: 'Core', month: '2025-11' },
    { rep: 'Steven Kovacs', date: '2025-11-18', market: 'Micro', month: '2025-11' },
    { rep: 'Afraz Afridi', date: '2025-11-27', market: 'Core', month: '2025-11' },
    { rep: 'Adam Mellouli', date: '2025-12-01', market: 'Micro', month: '2025-12' },
    { rep: 'Adam Mellouli', date: '2025-12-03', market: 'Micro', month: '2025-12' },
    { rep: 'Adam Mellouli', date: '2025-12-08', market: 'Core', month: '2025-12' },
    { rep: 'Adam Mellouli', date: '2025-12-10', market: 'Micro', month: '2025-12' },
    { rep: "Sid'Ali Terkmane", date: '2025-12-11', market: 'Core', month: '2025-12' },
    { rep: "Sid'Ali Terkmane", date: '2025-12-08', market: 'Micro', month: '2025-12' },
    { rep: 'Dale Liang', date: '2025-12-23', market: 'Micro', month: '2025-12' },
    { rep: 'Dale Liang', date: '2025-12-09', market: 'Core', month: '2025-12' },
    { rep: 'Matthew Beiler', date: '2025-12-12', market: 'Micro', month: '2025-12' },
    { rep: 'Adam Mellouli', date: '2026-01-06', market: 'Core', month: '2026-01' },
    { rep: 'Adam Mellouli', date: '2026-01-05', market: 'Micro', month: '2026-01' },
    { rep: "Sid'Ali Terkmane", date: '2026-01-06', market: 'Core', month: '2026-01' },
    { rep: "Sid'Ali Terkmane", date: '2026-01-05', market: 'Micro', month: '2026-01' },
    { rep: 'Dale Liang', date: '2026-01-09', market: 'Core', month: '2026-01' },
    { rep: 'Dale Liang', date: '2026-01-20', market: 'Micro', month: '2026-01' },
  ],
  OB: [
    { rep: 'Adam Mellouli', date: '2026-01-20', market: 'Core', month: '2026-01' },
    { rep: 'Dale Liang', date: '2026-01-13', market: 'Micro', month: '2026-01' },
    { rep: 'Steven Kovacs', date: '2026-01-27', market: 'Core', month: '2026-01' },
    { rep: 'Adam Mellouli', date: '2026-01-22', market: 'Mid-Market', month: '2026-01' },
    { rep: 'Adam Mellouli', date: '2026-01-20', market: 'Core', month: '2026-01' },
    { rep: 'Camilo Gomez', date: '2026-01-16', market: 'Core', month: '2026-01' },
    { rep: 'Steven Kovacs', date: '2026-01-28', market: 'Core', month: '2026-01' },
  ]
};

const MONTHS_ORDER = ['2025-11', '2025-12', '2026-01'];
const MONTH_LABELS = { '2025-11': 'Nov 2025', '2025-12': 'Dec 2025', '2026-01': 'Jan 2026' };

// ============================
// STATE
// ============================
let activeCampaign = 'PY';
let activeTimePeriod = 'all';
let charts = {};
let sortState = { col: 'win', dir: 'desc' };

// ============================
// HELPERS
// ============================

function parseCampaignCode(code) {
  let platform = 'Unknown';
  if (code.includes('Facebook')) platform = 'Facebook';
  else if (code.includes('Linkedin')) platform = 'LinkedIn';
  let lang = 'EN';
  if (code.includes('-FR-')) lang = 'FR';
  let region = 'National';
  if (code.includes('-ROC-')) region = 'Rest of Canada';
  else if (code.includes('-QC-')) region = 'Quebec';
  else if (code.includes('-NAT-')) region = 'National';
  let year = '2025';
  if (code.includes('2026') || code.includes('2601')) year = '2026';
  return `${platform} | ${lang} | ${region} | ${year}`;
}

function getHeatColor(val, max) {
  if (val === 0) return 'rgba(156, 163, 175, 0.12)';
  const intensity = Math.min(val / Math.max(max, 1), 1);
  return `rgba(22, 163, 74, ${0.08 + intensity * 0.3})`;
}

function getHeatTextColor(val) {
  return val > 0 ? '#15803d' : '#9ca3af';
}

// ============================
// TIME FILTERING
// ============================

function getFilteredDemos(campaign) {
  const demos = DEMOS[campaign] || [];
  if (activeTimePeriod === 'all' || activeTimePeriod === 'L3M') return demos;
  return demos.filter(d => d.month === activeTimePeriod);
}

function switchTimePeriod(period) {
  activeTimePeriod = period;
  renderAll();
}

// ============================
// CHART SUMMARIES
// ============================

function updateSummaries() {
  const d = DATA[activeCampaign];
  const avgWin = d.repTotals.reduce((s, r) => s + r.win, 0) / d.repTotals.length;
  const topRep = [...d.repTotals].sort((a, b) => b.win - a.win)[0];
  const zeroReps = d.repTotals.filter(r => r.win === 0);
  const totalDemos = d.repTotals.reduce((s, r) => s + r.demos, 0);
  const totalResolved = d.repTotals.reduce((s, r) => s + r.total, 0);
  const campName = activeCampaign === 'PY' ? 'Payroll Guide' : 'Onboarding Checklist';

  // Trend chart summary
  const trendDemos = DEMOS[activeCampaign] || [];
  const monthCounts = MONTHS_ORDER.map(m => ({ label: MONTH_LABELS[m], count: trendDemos.filter(d => d.month === m).length }));
  const lastCount = monthCounts[monthCounts.length - 1].count;
  const firstCount = monthCounts[0].count;
  const trending = lastCount > firstCount ? 'upward' : lastCount < firstCount ? 'downward' : 'flat';
  document.getElementById('summary-trend').innerHTML =
    `<strong>Source:</strong> Demo Booked dates from Salesforce Lead records. ` +
    monthCounts.map(m => `<strong>${m.label}:</strong> ${m.count} demo${m.count !== 1 ? 's' : ''}`).join(', ') + '. ' +
    `Trend is <strong>${trending}</strong>. Note: only Demo Booked leads have dates in this dataset; Lost and pipeline leads are shown as all-time totals.`;

  // Rep bar chart summary
  document.getElementById('summary-rep').innerHTML =
    `<strong>Source:</strong> Salesforce Lead data filtered to "${campName}" campaigns, grouped by Lead Owner. Win % = Demo Booked / (Demo Booked + Lost). ` +
    `The top performer is <strong>${topRep.rep}</strong> at ${topRep.win.toFixed(1)}%, while ` +
    `<strong>${zeroReps.length} rep${zeroReps.length !== 1 ? 's' : ''}</strong> have 0% conversion. Team average is ${avgWin.toFixed(1)}%.`;

  // Market donut summary
  const bestMarket = [...d.marketTotals].sort((a, b) => b.win - a.win)[0];
  const zeroMarkets = d.marketTotals.filter(m => m.win === 0);
  document.getElementById('summary-market').innerHTML =
    `<strong>Source:</strong> Leads grouped by Market segment (employee count). ` +
    `<strong>${bestMarket.market}</strong> converts best at ${bestMarket.win.toFixed(1)}% (${bestMarket.demos} demos from ${bestMarket.total} leads).` +
    (zeroMarkets.length > 0 ? ` <strong>${zeroMarkets.map(m=>m.market).join(', ')}</strong> has 0% conversion despite ${zeroMarkets.reduce((s,m)=>s+m.total,0)} resolved leads.` : '');

  // Funnel summary
  const huntingPct = ((d.leadStatus.find(s=>s.status==='Hunting')?.count || 0) / d.totalLeads * 100).toFixed(0);
  const lostPct = ((d.leadStatus.find(s=>s.status==='Lost')?.count || 0) / d.totalLeads * 100).toFixed(0);
  document.getElementById('summary-funnel').innerHTML =
    `<strong>Source:</strong> Current Lead Status field from Salesforce for all ${d.totalLeads} leads on this campaign. ` +
    `${lostPct}% are Lost, ${huntingPct}% are still in Hunting. Only ${totalDemos} have reached Demo Booked.`;

  // Campaign variant summary
  const convertingCamps = d.campaigns.filter(c => c.demos > 0);
  const bestCamp = [...d.campaigns].sort((a,b) => (b.total>0?b.demos/b.total:0) - (a.total>0?a.demos/a.total:0))[0];
  const bestCampRate = bestCamp.total > 0 ? ((bestCamp.demos / bestCamp.total) * 100).toFixed(1) : '0';
  document.getElementById('summary-campaign').innerHTML =
    `<strong>Source:</strong> Campaign Name field from Salesforce, parsed by channel/language/region. ` +
    `${convertingCamps.length} of ${d.campaigns.length} variants are generating demos. ` +
    `<strong>${parseCampaignCode(bestCamp.code)}</strong> leads at ${bestCampRate}% conversion.`;

  // Heatmap summary
  const zeroCount = d.repMarket.filter(r => r.win === 0).length;
  const totalCells = d.repMarket.length;
  document.getElementById('summary-heatmap').innerHTML =
    `<strong>Source:</strong> Cross-tabulation of Lead Owner x Market segment. ` +
    `${zeroCount} of ${totalCells} rep-market combinations (${((zeroCount/totalCells)*100).toFixed(0)}%) show 0% conversion. ` +
    `This helps isolate whether underperformance is rep-specific, market-specific, or both.`;

  // Data table summary
  document.getElementById('summary-table').innerHTML =
    `<strong>Source:</strong> All ${totalResolved} resolved leads (Demo Booked + Lost) from Salesforce, broken down by Lead Owner and Market. ` +
    `Leads still in Hunting, New, or Working are excluded from conversion calculations to show true completion rates.`;
}

// ============================
// RENDER FUNCTIONS
// ============================

function updateKPIs() {
  const d = DATA[activeCampaign];
  const totalDemos = d.repTotals.reduce((s, r) => s + r.demos, 0);
  const totalResolved = d.repTotals.reduce((s, r) => s + r.total, 0);
  const convRate = totalResolved > 0 ? ((totalDemos / totalResolved) * 100).toFixed(2) : '0.00';

  document.getElementById('kpi-leads').textContent = d.totalLeads.toLocaleString();
  document.getElementById('kpi-leads-detail').textContent = activeCampaign === 'PY'
    ? '719 leads across 6 variants'
    : '372 leads across 5 variants';

  document.getElementById('kpi-conv').textContent = convRate + '%';
  document.getElementById('kpi-conv-detail').textContent = `${totalDemos} demos / ${totalResolved} resolved`;

  const filteredDemos = getFilteredDemos(activeCampaign);
  if (activeTimePeriod !== 'all' && activeTimePeriod !== 'L3M') {
    const periodLabel = MONTH_LABELS[activeTimePeriod] || activeTimePeriod;
    document.getElementById('kpi-demos').textContent = filteredDemos.length;
    document.getElementById('kpi-demos-detail').textContent = `${periodLabel} (${totalDemos} all-time)`;
  } else {
    document.getElementById('kpi-demos').textContent = totalDemos;
    document.getElementById('kpi-demos-detail').textContent = `From ${totalResolved} resolved leads`;
  }

  document.getElementById('kpi-sdrs').textContent = d.repTotals.length;
  document.getElementById('kpi-sdrs-detail').textContent = 'Working this campaign';

  document.getElementById('kpi-campaigns').textContent = d.variants;
  document.getElementById('kpi-campaigns-detail').textContent = 'Active variants';
}

function renderRepBarChart() {
  const d = DATA[activeCampaign];
  const sorted = [...d.repTotals].sort((a, b) => a.win - b.win);
  const avgWin = sorted.reduce((s, r) => s + r.win, 0) / sorted.length;

  const labels = sorted.map(r => r.rep);
  const values = sorted.map(r => r.win);
  const colors = sorted.map(r => {
    if (r.win === 0) return 'rgba(156,163,175,0.4)';
    return r.win >= avgWin ? 'rgba(22,163,74,0.75)' : 'rgba(220,38,38,0.65)';
  });

  if (charts.repBar) charts.repBar.destroy();

  charts.repBar = new Chart(document.getElementById('repBarChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Win %',
        data: values,
        backgroundColor: colors,
        borderColor: colors.map(c => c.replace(/[\d.]+\)$/, '1)')),
        borderWidth: 1,
        borderRadius: 4,
        barThickness: 28,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const rep = sorted[ctx.dataIndex];
              return `Win: ${rep.win.toFixed(2)}% (${rep.demos} demos / ${rep.total} total)`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { color: '#525872', callback: v => v + '%' },
          title: { display: true, text: 'Win Rate %', color: '#8890a8' },
        },
        y: {
          grid: { display: false },
          ticks: { color: '#1a1d2e', font: { size: 12 } },
        }
      }
    }
  });
}

function renderMarketDonut() {
  const d = DATA[activeCampaign];
  const labels = d.marketTotals.map(m => m.market);
  const totals = d.marketTotals.map(m => m.total);
  const bgColors = ['rgba(109,40,217,0.75)', 'rgba(37,99,235,0.75)', 'rgba(217,119,6,0.75)'];

  if (charts.donut) charts.donut.destroy();

  charts.donut = new Chart(document.getElementById('marketDonut'), {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: totals,
        backgroundColor: bgColors,
        borderColor: ['#fff','#fff','#fff'],
        borderWidth: 3,
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '62%',
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: { color: '#1a1d2e', padding: 16, usePointStyle: true, pointStyleWidth: 12 }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const m = d.marketTotals[ctx.dataIndex];
              return `${m.market}: ${m.total} leads (${m.win.toFixed(2)}% conv, ${m.demos} demos)`;
            }
          }
        }
      }
    }
  });

  let legendHtml = '<div style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">';
  d.marketTotals.forEach((m, i) => {
    legendHtml += `<div style="display:flex;align-items:center;gap:6px;">
      <span style="width:12px;height:12px;border-radius:3px;background:${bgColors[i]};display:inline-block;"></span>
      <span style="font-size:12px;color:#525872;"><strong style="color:#1a1d2e;">${m.market}</strong> ${m.total} leads / ${m.win.toFixed(2)}% conv</span>
    </div>`;
  });
  legendHtml += '</div>';
  document.getElementById('market-legend').innerHTML = legendHtml;
}

function renderFunnel() {
  const d = DATA[activeCampaign];
  const funnelOrder = ['New', 'New Contact', 'Hunting', 'Working', 'Qualified', 'Demo Booked', 'Lost'];
  const funnelColors = {
    'New': '#6d28d9',
    'New Contact': '#7c3aed',
    'Hunting': '#2563eb',
    'Working': '#d97706',
    'Qualified': '#16a34a',
    'Demo Booked': '#15803d',
    'Lost': '#dc2626',
  };

  const statusMap = {};
  d.leadStatus.forEach(s => { statusMap[s.status] = s.count; });
  const maxCount = Math.max(...d.leadStatus.map(s => s.count));

  const container = document.getElementById('funnel-container');
  let html = '';

  funnelOrder.forEach(status => {
    const count = statusMap[status] || 0;
    if (count === 0) return;
    const pct = (count / maxCount) * 100;
    const totalPct = ((count / d.totalLeads) * 100).toFixed(1);
    html += `
      <div class="funnel-step">
        <div class="funnel-label">${status}</div>
        <div class="funnel-bar-wrapper">
          <div class="funnel-bar" style="width:${Math.max(pct, 8)}%;background:${funnelColors[status] || '#8890a8'};">
            ${count}
          </div>
          <span class="funnel-count">${totalPct}% of total</span>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

function renderCampaignChart() {
  const d = DATA[activeCampaign];
  const labels = d.campaigns.map(c => parseCampaignCode(c.code));
  const convRates = d.campaigns.map(c => c.total > 0 ? ((c.demos / c.total) * 100) : 0);
  const totals = d.campaigns.map(c => c.total);

  const colors = convRates.map(r => r > 0 ? 'rgba(109,40,217,0.7)' : 'rgba(156,163,175,0.35)');

  if (charts.campaign) charts.campaign.destroy();

  charts.campaign = new Chart(document.getElementById('campaignChart'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Conversion %',
          data: convRates,
          backgroundColor: colors,
          borderColor: colors.map(c => c.replace(/[\d.]+\)$/, '1)')),
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y',
        },
        {
          label: 'Lead Volume',
          data: totals,
          type: 'line',
          borderColor: 'rgba(37,99,235,0.7)',
          backgroundColor: 'rgba(37,99,235,0.05)',
          pointBackgroundColor: 'rgba(37,99,235,1)',
          pointRadius: 5,
          borderWidth: 2,
          yAxisID: 'y1',
          fill: false,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#525872', usePointStyle: true }
        },
        tooltip: {
          callbacks: {
            afterLabel: (ctx) => {
              if (ctx.datasetIndex === 0) {
                const c = d.campaigns[ctx.dataIndex];
                return `${c.demos} demos from ${c.total} leads`;
              }
              return '';
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#525872', font: { size: 10 }, maxRotation: 25 },
        },
        y: {
          position: 'left',
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { color: '#525872', callback: v => v + '%' },
          title: { display: true, text: 'Conversion %', color: '#8890a8' },
        },
        y1: {
          position: 'right',
          grid: { display: false },
          ticks: { color: '#2563eb' },
          title: { display: true, text: 'Lead Volume', color: '#2563eb' },
        }
      }
    }
  });
}

function renderTrendChart() {
  const demos = DEMOS[activeCampaign] || [];
  const reps = [...new Set(demos.map(d => d.rep))].sort();
  const REP_COLORS = [
    'rgba(109,40,217,0.8)', 'rgba(37,99,235,0.8)', 'rgba(22,163,74,0.8)',
    'rgba(217,119,6,0.8)', 'rgba(220,38,38,0.8)', 'rgba(234,88,12,0.8)',
    'rgba(6,182,212,0.8)', 'rgba(168,85,247,0.8)', 'rgba(236,72,153,0.8)',
    'rgba(20,184,166,0.8)'
  ];

  const datasets = reps.map((rep, i) => ({
    label: rep,
    data: MONTHS_ORDER.map(m => demos.filter(d => d.rep === rep && d.month === m).length),
    backgroundColor: REP_COLORS[i % REP_COLORS.length],
    borderRadius: 3,
  }));

  if (charts.trend) charts.trend.destroy();

  charts.trend = new Chart(document.getElementById('trendChart'), {
    type: 'bar',
    data: {
      labels: MONTHS_ORDER.map(m => MONTH_LABELS[m]),
      datasets: datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#525872', usePointStyle: true, pointStyleWidth: 10, font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.raw} demo${ctx.raw !== 1 ? 's' : ''}`
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          grid: { display: false },
          ticks: { color: '#525872' },
        },
        y: {
          stacked: true,
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { color: '#525872', stepSize: 1 },
          title: { display: true, text: 'Demos Booked', color: '#8890a8' },
        }
      }
    }
  });
}

function renderHeatmap() {
  const d = DATA[activeCampaign];
  const markets = [...new Set(d.repMarket.map(r => r.market))];
  const reps = [...new Set(d.repMarket.map(r => r.rep))];

  const repTotalMap = {};
  d.repTotals.forEach(r => { repTotalMap[r.rep] = r.win; });
  reps.sort((a, b) => (repTotalMap[b] || 0) - (repTotalMap[a] || 0));

  const maxWin = Math.max(...d.repMarket.map(r => r.win));

  let html = '<table class="heatmap-table"><thead><tr><th>Rep</th>';
  markets.forEach(m => { html += `<th>${m}</th>`; });
  html += '<th>Overall</th></tr></thead><tbody>';

  reps.forEach(rep => {
    html += `<tr><td>${rep}</td>`;
    markets.forEach(market => {
      const entry = d.repMarket.find(r => r.rep === rep && r.market === market);
      if (entry) {
        const bg = getHeatColor(entry.win, maxWin);
        const textCol = getHeatTextColor(entry.win);
        html += `<td><span class="heat-cell" style="background:${bg};color:${textCol};">${entry.win.toFixed(1)}%</span></td>`;
      } else {
        html += '<td><span class="heat-cell" style="background:rgba(156,163,175,0.08);color:#9ca3af;">-</span></td>';
      }
    });
    const repTotal = d.repTotals.find(r => r.rep === rep);
    const overallWin = repTotal ? repTotal.win : 0;
    const bg = getHeatColor(overallWin, maxWin);
    const textCol = getHeatTextColor(overallWin);
    html += `<td><span class="heat-cell" style="background:${bg};color:${textCol};font-weight:800;">${overallWin.toFixed(1)}%</span></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('heatmap-wrapper').innerHTML = html;
}

function renderCoaching() {
  const d = DATA[activeCampaign];
  const avgWin = d.repTotals.reduce((s, r) => s + r.win, 0) / d.repTotals.length;

  const topPerformers = d.repTotals.filter(r => r.win > avgWin).sort((a, b) => b.win - a.win);
  const zeroPerformers = d.repTotals.filter(r => r.win === 0);
  const zeroMarkets = d.marketTotals.filter(m => m.win === 0);

  const activeRepsAboveZero = d.repTotals.filter(r => r.win > 0).length;
  const totalReps = d.repTotals.length;
  const repConvertingPct = ((activeRepsAboveZero / totalReps) * 100).toFixed(0);

  let html = '';

  // Top performers
  html += '<div class="coaching-section top-performers"><h3>Top Performers</h3>';
  if (topPerformers.length > 0) {
    topPerformers.forEach(r => {
      html += `<div class="coaching-item"><strong>${r.rep}</strong> - ${r.win.toFixed(2)}% win rate (${r.demos} demos from ${r.total} leads)<span class="badge badge-green">Above Avg</span></div>`;
    });
  } else {
    html += '<div class="coaching-item">No reps above average conversion rate</div>';
  }
  html += `<div class="coaching-item" style="margin-top:8px;font-size:11px;color:var(--text-muted);">Team average: ${avgWin.toFixed(2)}%</div>`;
  html += '</div>';

  // Needs coaching
  html += '<div class="coaching-section needs-coaching"><h3>Needs Coaching (0% Conversion)</h3>';
  if (zeroPerformers.length > 0) {
    zeroPerformers.forEach(r => {
      html += `<div class="coaching-item"><strong>${r.rep}</strong> - 0 demos from ${r.total} leads<span class="badge badge-red">0% Conv</span></div>`;
    });
  } else {
    html += '<div class="coaching-item">All reps have booked at least 1 demo</div>';
  }
  html += '</div>';

  // Market alerts
  html += '<div class="coaching-section market-alert"><h3>Market Segment Alerts</h3>';
  if (zeroMarkets.length > 0) {
    zeroMarkets.forEach(m => {
      html += `<div class="coaching-item"><strong>${m.market}</strong> - 0% conversion across ${m.total} leads<span class="badge badge-amber">Investigate</span></div>`;
    });
    if (activeCampaign === 'PY') {
      html += '<div class="coaching-item" style="margin-top:8px;">Mid-Market has generated <strong>0 demos from 95 leads</strong> across all reps. This suggests a systemic issue with offer-market fit, not individual rep performance.</div>';
    }
  } else {
    html += '<div class="coaching-item">All market segments are converting</div>';
  }
  html += '</div>';

  // Diagnostic
  html += '<div class="coaching-section diagnostic"><h3>Rep Problem vs Campaign Problem</h3>';
  html += `<div class="coaching-item"><strong>${activeRepsAboveZero} of ${totalReps}</strong> reps (${repConvertingPct}%) have booked at least 1 demo</div>`;

  if (zeroMarkets.length > 0 && zeroPerformers.length > 0) {
    html += '<div class="coaching-item" style="margin-top:6px;"><strong>Diagnosis: Mixed Signal</strong></div>';
    html += `<div class="coaching-item">Some reps converting in some markets suggests <strong>both</strong> rep skill gaps AND campaign/market fit issues.</div>`;
    html += `<div class="coaching-item">- <strong>Rep-level:</strong> ${zeroPerformers.length} reps at 0% need immediate coaching intervention</div>`;
    html += `<div class="coaching-item">- <strong>Campaign-level:</strong> ${zeroMarkets.map(m => m.market).join(', ')} market(s) at 0% suggest offer/targeting misalignment</div>`;
  } else if (zeroPerformers.length > 0) {
    html += '<div class="coaching-item" style="margin-top:6px;"><strong>Diagnosis: Rep Skill Gap</strong></div>';
    html += '<div class="coaching-item">All markets are converting, so this is primarily a rep coaching opportunity.</div>';
  } else if (zeroMarkets.length > 0) {
    html += '<div class="coaching-item" style="margin-top:6px;"><strong>Diagnosis: Campaign/Market Fit</strong></div>';
    html += '<div class="coaching-item">All reps are converting but some markets are not. Review campaign targeting and offer for those segments.</div>';
  } else {
    html += '<div class="coaching-item" style="margin-top:6px;"><strong>Diagnosis: Healthy</strong> - All reps and all markets showing conversions.</div>';
  }

  const highVolLowConv = d.repTotals.filter(r => r.total > 50 && r.win < avgWin);
  if (highVolLowConv.length > 0) {
    html += '<div class="coaching-item" style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;"><strong>Volume Watch:</strong></div>';
    highVolLowConv.forEach(r => {
      html += `<div class="coaching-item">${r.rep} has high volume (${r.total} leads) but below-average conversion (${r.win.toFixed(2)}%). May benefit from lead quality review.</div>`;
    });
  }

  html += '</div>';

  document.getElementById('coaching-grid').innerHTML = html;
}

function renderDataTable() {
  const d = DATA[activeCampaign];

  const cols = [
    { key: 'rep', label: 'Rep' },
    { key: 'market', label: 'Market' },
    { key: 'demos', label: 'Demos Booked' },
    { key: 'lost', label: 'Lost' },
    { key: 'total', label: 'Total Resolved' },
    { key: 'win', label: 'Win %' },
  ];

  let headHtml = '<tr>';
  cols.forEach(c => {
    const arrow = sortState.col === c.key ? (sortState.dir === 'asc' ? ' &#9650;' : ' &#9660;') : '';
    headHtml += `<th onclick="sortTable('${c.key}')">${c.label}<span class="sort-arrow">${arrow}</span></th>`;
  });
  headHtml += '</tr>';
  document.getElementById('table-head').innerHTML = headHtml;

  let rows = [...d.repMarket];
  rows.sort((a, b) => {
    let va = a[sortState.col];
    let vb = b[sortState.col];
    if (typeof va === 'string') {
      return sortState.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
    }
    return sortState.dir === 'asc' ? va - vb : vb - va;
  });

  let bodyHtml = '';
  rows.forEach(r => {
    const barWidth = Math.min(r.win * 4, 100);
    const barColor = r.win === 0 ? '#d1d5db' : (r.win >= 10 ? '#16a34a' : '#d97706');
    bodyHtml += `<tr>
      <td style="color:var(--text-primary);font-weight:500;">${r.rep}</td>
      <td>${r.market}</td>
      <td style="color:${r.demos > 0 ? 'var(--accent-green)' : 'var(--text-muted)'}; font-weight:${r.demos > 0 ? '700' : '400'};">${r.demos}</td>
      <td>${r.lost}</td>
      <td>${r.total}</td>
      <td>
        <div class="win-rate-bar">
          <div class="win-rate-fill" style="width:${barWidth}px;background:${barColor};"></div>
          <span style="color:${r.win > 0 ? '#1a1d2e' : '#9ca3af'}">${r.win.toFixed(2)}%</span>
        </div>
      </td>
    </tr>`;
  });
  document.getElementById('table-body').innerHTML = bodyHtml;
}

function sortTable(col) {
  if (sortState.col === col) {
    sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
  } else {
    sortState.col = col;
    sortState.dir = col === 'rep' || col === 'market' ? 'asc' : 'desc';
  }
  renderDataTable();
}

// ============================
// CAMPAIGN SWITCH
// ============================

function switchCampaign(campaign) {
  activeCampaign = campaign;
  document.getElementById('btn-py').classList.toggle('active', campaign === 'PY');
  document.getElementById('btn-ob').classList.toggle('active', campaign === 'OB');
  renderAll();
}

function renderAll() {
  const note = document.getElementById('time-note');
  note.classList.toggle('visible', activeTimePeriod !== 'all' && activeTimePeriod !== 'L3M');
  updateKPIs();
  renderTrendChart();
  renderRepBarChart();
  renderMarketDonut();
  renderFunnel();
  renderCampaignChart();
  renderHeatmap();
  renderCoaching();
  renderDataTable();
  updateSummaries();
}

// ============================
// INIT
// ============================
document.addEventListener('DOMContentLoaded', () => {
  renderAll();
});
</script>
</body>
</html>
